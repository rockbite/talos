{"version":3,"file":"createAsyncStoragePersistor-experimental.development.js","sources":["../src/createAsyncStoragePersistor-experimental/index.ts"],"sourcesContent":["import { PersistedClient, Persistor } from '../persistQueryClient-experimental'\n\ninterface AsyncStorage {\n  getItem: (key: string) => Promise<string | null>\n  setItem: (key: string, value: string) => Promise<void>\n  removeItem: (key: string) => Promise<void>\n}\n\ninterface CreateAsyncStoragePersistorOptions {\n  /** The storage client used for setting an retrieving items from cache */\n  storage: AsyncStorage\n  /** The key to use when storing the cache */\n  key?: string\n  /** To avoid spamming,\n   * pass a time in ms to throttle saving the cache to disk */\n  throttleTime?: number\n  /**\n   * How to serialize the data to storage.\n   * @default `JSON.stringify`\n   */\n  serialize?: (client: PersistedClient) => string\n  /**\n   * How to deserialize the data from storage.\n   * @default `JSON.parse`\n   */\n  deserialize?: (cachedString: string) => PersistedClient\n}\n\nexport const createAsyncStoragePersistor = ({\n  storage,\n  key = `REACT_QUERY_OFFLINE_CACHE`,\n  throttleTime = 1000,\n  serialize = JSON.stringify,\n  deserialize = JSON.parse,\n}: CreateAsyncStoragePersistorOptions): Persistor => {\n  return {\n    persistClient: asyncThrottle(\n      persistedClient => storage.setItem(key, serialize(persistedClient)),\n      { interval: throttleTime }\n    ),\n    restoreClient: async () => {\n      const cacheString = await storage.getItem(key)\n\n      if (!cacheString) {\n        return\n      }\n\n      return deserialize(cacheString) as PersistedClient\n    },\n    removeClient: () => storage.removeItem(key),\n  }\n}\n\nfunction asyncThrottle<Args extends readonly unknown[], Result>(\n  func: (...args: Args) => Promise<Result>,\n  { interval = 1000, limit = 1 }: { interval?: number; limit?: number } = {}\n) {\n  if (typeof func !== 'function') throw new Error('argument is not function.')\n  const running = { current: false }\n  let lastTime = 0\n  let timeout: number\n  const queue: Array<Args> = []\n  return (...args: Args) =>\n    (async () => {\n      if (running.current) {\n        lastTime = Date.now()\n        if (queue.length > limit) {\n          queue.shift()\n        }\n\n        queue.push(args)\n        clearTimeout(timeout)\n      }\n      if (Date.now() - lastTime > interval) {\n        running.current = true\n        await func(...args)\n        lastTime = Date.now()\n        running.current = false\n      } else {\n        if (queue.length > 0) {\n          const lastArgs = queue[queue.length - 1]!\n          timeout = setTimeout(async () => {\n            if (!running.current) {\n              running.current = true\n              await func(...lastArgs)\n              running.current = false\n            }\n          }, interval)\n        }\n      }\n    })()\n}\n"],"names":["value","then","direct","Promise","resolve","f","args","i","arguments","length","apply","e","reject","body","result","createAsyncStoragePersistor","storage","key","throttleTime","serialize","JSON","stringify","deserialize","parse","persistClient","asyncThrottle","persistedClient","setItem","interval","restoreClient","getItem","cacheString","removeClient","removeItem","func","limit","Error","running","current","lastTime","timeout","queue","Date","now","shift","push","clearTimeout","lastArgs","setTimeout"],"mappings":"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"}